#' Extracting AUCs by data sets
#'
#' After coclustering optimization, visualize AUCs generated by optimal parameter settings on validating data sets.

#' @param wk.dir The directory containing co-clustering results that are generated by \code{coclus_opt}. 
#' @inheritParams auc_param

#' @return An object of ggplot.

#' @examples

#' # Create parameter settings and corresponding aucs.
#' df.auc <- data.frame(auc=runif(n=5, min=1e-12, max=.99))
#' ran <- seq(0.2, 0.8, 0.1)
#' df.spd <- data.frame(sim=sample(ran, 5, replace=FALSE), sim.p=sample(ran, 5, replace=FALSE), dim=sample(seq(5, 40, 1), 5, replace=FALSE))
#' df.spd$spd.set <- paste0('s', df.spd$sim, 'p', df.spd$sim.p, 'd', df.spd$dim)
#' 
#' df.auc <- cbind(df.spd, df.auc)
#' # Plot the aucs.
#' auc_bar(df.auc, auc='auc', thr=0.5) 

#' # See package vignette by calling "browseVignettes('spatialHeatmap')".

#' @author Jianhai Zhang \email{jzhan067@@ucr.edu} \cr Dr. Thomas Girke \email{thomas.girke@@ucr.edu}

#' @export auc_dataset

auc_dataset <- function(wk.dir, min.true=300, min.total=500, min.auc=0.5) {
  dir <-file.path(wk.dir, 'auc_res')
  files <- list.files(file.path(wk.dir, 'auc_res'), '^auc.*\\.rds$')
  files <- sort(files)
  cell <- unique(gsub('auc\\.|knn\\.|snn\\.|pca\\.|umap\\.|fil\\d+\\.|fct\\.|cpm\\.|\\.rds', '', files))
  # All component names in ".rds" files.
  # nas <- unique(unlist(strsplit(files, '\\.')))
  # cell <- setdiff(nas, c('auc', 'dat', 'rds', unlist(par.lis)))

  auc.lis <- rep(list(NULL), length(cell))
  names(auc.lis) <- cell
  # All parameters under optimization.
  pars <- c('norm', 'filter', 'dimred', 'graph.meth', 'sim', 'sim.p', 'dim', 'spd.set', 'true', 'total', 'auc') 
  # Extract all AUCs for each single cell data.
  for (i in cell) {
    files0 <- file.path(dir, grep(paste0('\\.', i, '\\.'), files, value=TRUE)) 
    df.auc0 <- NULL; for (j in files0) {
      df.auc0 <- rbind(df.auc0, readRDS(j)[, pars])
    }
    # Settings are same for each cell. Rank the data frame according to settings so that the order are the same for each cell.
    df.auc0$mix <- do.call(paste, c(df.auc0[setdiff(pars, c('true', 'total', 'auc'))], sep="_"))
    df.auc0 <- df.auc0[order(df.auc0$mix), ]
    df.auc0$mix <- NULL
    # Settings are labelled by index.
    rownames(df.auc0) <- df.auc0$index <- seq_len(nrow(df.auc0))
    auc.lis[[i]] <- df.auc0
  }    
  # Filter weak settings.
  auc.lis <- lapply(auc.lis, function(x) {
    x$auc[x$true < min.true | x$total < min.total | x$auc < min.auc] <- 0; x
  })
  auc.lis
}
