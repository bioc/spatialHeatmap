--- 
title: "Tutorial of Spatial Heatmap"
author: "Jianhai Zhang (UCR PhD student) <p/> Advisor: Prof. Dr. Thomas Girke (UCR)"
date: "Last update: `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_float:
        collapsed: true
        smooth_scroll: true
    toc_depth: 3
    fig_caption: yes
    code_folding: show
    number_sections: true
fontsize: 14pt
bibliography: bibtex.bib
---

<style>body { text-align: justify }</style>

Maintainer: Jianhai Zhang (<jzhan067@ucr.edu;> <zhang.jianhai@hotmail.com>)

# Summary

This Shiny App based Spatial Heatmap can be used for interactive visualisation as long as a data matrix and an associated svg image are provided. This tutorial is specifically designed for how to make svg image and link it with gene expression matrix. The tutorial requires a png image with each region coloured by a unique colour, a data matrix, the svg editor Inkscape, and optionally the image editor GIMP. The png image is the template to make the svg image while the data matrix is used to fill different regions in the image. Inkscape is used to associate the svg image with the data matrix and GIMP is optionally used to facilitate making the svg image. 

In the following the tutorial is given with a gene expression matrix and an associated root tissue image in SVG format as an example. It is just a basic example for users without experience to start, which includes almost all the necessary steps relevant to using this App. All the files used in this tutorial can be downloaded <a href=http://biocluster.ucr.edu/~jzhan067/shiny_HM_tutorial/>here</a>.

  <b>Users are advised to pay enough attention to the bold text below, because it can prevent common errors when using the App. </b>

# Procedure

## Gene expression matrix

  In the gene matrix, the row and column names are often gene IDs and samples/conditions respectively, and one column of annotation can also be included. The dimension names can be transposed. <b>The sample names shoud be followed by double underscore and then the condition names, eg: epidermis__standard_1h [@Geng2013-ek], where epidermis is the tissue and standard_1h is the condition. In names of sample, condition, and annotation, only letters, digits, single underscore, dots are allowed</b>.

  <p/><center><img src="img/gene_matrix.png"></center> <p/>

## Make svg images 

### <a name="draw"></a> Make blank svg images by drawing 

If the contour in the png image is not clear, GIMP can generate low-quality svg images. In this case, one can draw the blank svg image on Inkscape by using the png as a template. Below is an example of drawing only two polygons.

  1. Draw polygons <p/><p/> 
  Open the root png image [@Mustroph2009-nu] in Inkscape. The image can be zoomed by press "-" or "+" on the keyboard. Select the "Draw freeahnd lines (F6)" at the left tool bar. Left click once at the first corner of the polygon, and move to the second corner and double left click, and so on. Lastly, when drawing the last line click at the first corner to seal the polygon.
  <p/><center><img src="img/open.png" height="100" width="100" hspace=30><img src="img/draw_freehand_line.png"></center><p/>
  <p/><center/><img src="img/draw_first_line.png" height="200" width="200"><img src="img/double_click.png" height="200" width="200"><img src="img/draw_second_line.png" height="180" width="180"><img src="img/draw_last_line.png" height="180" width="180"></center><p/>

  2. Overlay polygons <p/><p/> 
  Select "Edit path by nodes (F2)" from the left tool bar. Draw a large rectangle to select the whole sealed polygon and draw a large rectangle to select all nodes.
  <p/><center><img src="img/edit_path_tool.png" height="150" width="150"><img src="img/select_path.png" height="200" width="200"><img src="img/select_path1.png" height="200" width="200"><img src="img/select_node.png" height="200" width="200"><img src="img/select_node1.png" height="200" width="200"></center><p/>

    Click the "Make selected nodes smooth" in the top tool bar. Drag the edges and handles to make the sealed polygon overlap with the template, then the first polygon is created. <p/>
  <center><img src="img/make_selected_nodes_smooth.png" height="200" width="200"><img src="img/node_smooth.png" height="200" width="200"><img src="img/drag_edge.png" height="200" width="200"><img src="img/drag_handle.png" height="200" width="200"><img src="img/first_polygon.png" height="200" width="200"></center><p/>

  3. <a name="shape"></a> Make polygons with shapes <p/><p/>
  Alternatively, the polygons can be made with rectangles. Click "Create rectangles and squares (F4)" at the left tool bar and draw a rectangle in the second template polygon. Select the rectangle and click "Object to Path" under the "Path" tab at the top, then the rectangle becomes an svg path, which can be edited. Switch cursor to "Select and Transform Objects (F1)" and rotate the rectangle. <p/>

  <p/><center><img src="img/create_rectangle.png" height="200" width="200" hspace=15><img src="img/draw_rectangle1.png" height="200" width="200" hspace=15><img src="img/object_to_path1.png" height="200" width="200"></center><p/>
  <center><img src="img/select_tool.png" height="300" width="300" hspace=15><img src="img/rotate_rectangle.png" height="200" width="200"></center><p/>

  &nbsp; &nbsp; Switch the cursor to "Edit path by nodes (F2)" and select all nodes of the rectangle. Click "Make selected nodes corner" at the top tool bar. Drag the edges and handles to overlay the rectangle path on the template, then the second polygon is drawn. <p/>

  <p/><center/><img src="img/select_rectangle_node.png" height="200" width="200"><img src="img/make_node_corner.png" height="200" width="200"><img src="img/drag_rectangle.png" height="200" width="200"><img src="img/second_polygon.png" height="200" width="200"><p/> <p/><p/>

  In this root image there are many polygons, so it is time-consuming to draw them individually. In order to same time, GIMP can be used to extract the polygons automatically. <p/>

### Make blank svg images with GIMP

If the png image contains many polygons and their contour is clear (e.g. the root image), GIMP can be used to automatically extract the polygons. <p/>

  4. Open the root png image with GIMP. There are five coloured tissues (skyblue, green, red, yellow, blue). The skyblue is not present in the gene matrix while the green, red, yellow, blue correspond to epidermis, cortex, endodermis, stele in the gene matrix respectively. Enable the "Paths" panel under the "Windows" tab at the top. Right click and select "By Color" under "Select". <p/>
  <p/><center><img src="img/open1.png" height="200" width="200" hspace=10><img src="img/path_panel.png" height="250" width="250" hspace=10><img src="img/by_color.png" height="250" width="250"></center> <p/>

  5. Click on the skyblue tissue, then right click, select "To Path" under "Select", and the paths of the all skyblue tissues is shown in the "Paths" panel. <p/>
     <center><img src="img/click_first_color.png" height="200" width="200" hspace=10><img src="img/to_path.png" height="250" width="250" hspace=10><img src="img/first_path.png"></center><p/>

  6. Similarly, exrtact paths of other tissues. In the "Paths" panel, and set paths visible by enabling the eye symbol, then right click and merge visible paths. Right click and export merged paths, which is a blank svg image. <p/>
  <center><img src="img/eye.png" height="200" width="200" hspace="10"><img src="img/merge.png" height="200" width="200" hspace="10"><img src="img/export.png" height="200" width="200"></center> <p/>

### Make blank svg images with GIMP and drawing

The drawing method produce accurate svg images but it is time-consuming, while the GIMP method is faster but it can generate fused polygons. In this tutorial, the root png image has well separated polygons and clear contours, so GIMP can produce accurate svg images. Otherwise the resulting svg images would have mixed and noise polygons. Considering the pros and cons of two methods, the good practice is to use GIMP to extract polygons first then use drawing the refine the blank svg image. Below is an example of an svg image with fused polygons, which is generated by GIMP.

  7. <a name="layer"></a> Place all svg paths inside a layer <p/><p/>
  Open the blank fused svg image in Inkscape (the image can be zoomed by press "-" or "+" on the keyboard). Under the "Layers" tab at the top click "Layers", the "Layers" panel will come out on the right, then click "+" at the bottom left corner of the panel to add "Layer 1". 
  <p/><center><img src="img/layer.png" height="150" width="150" hspace=10><img src="img/add_layer.png" height="250" width="500"></center><p/>

    Draw a rectangle over the fused svg graph and cut. Then click on "Layer 1" and paste the fused svg to "Layer 1" (make sure the "Layer 1" is unlocked by refering to the lock symbol). Open the "XML Editor" from the "Edit" tab at the top, if "\<svg:path id="path 77"\>" is under "\<svg:g id="layer1" inkscape:label="Layer 1"\>", then the fused svg is inside \"Layer 1\" for sure. 
     <p/><center><img src="img/draw_rectangle.png" hspace="10" height="150" width="150"><img src="img/click_layer.png" hspace="10" height="150" width="200"><img src="img/paste_layer.png" height="200" width="200"><img src="img/to_layer.png" height="150" width="150"><img src="img/in_layer.png" height="250" width="250"></center> <p/>

  8. Refine and modify the svg image <p/><p/>
  Draw a ractangle over the image, click "Break Apart" under the "Path" tag, then select the outer noisy rectangle by clicing on its edge. Press "delete" on the keyboard to delete it. <p/>
  <center><img src="img/break_apart1.png" height="150" width="150" hspace="15"><img src="img/remove_outer_frame.png" height="100" width="100" hspace="15"><img src="img/removed.png" height="150" width="150"></center> <p/> 

    Click on the edge of large fused polygon and move. Use the [drawing method](#draw) to make new polygons (blue) with the fused ones as templates. Place back the new polygons to make the tissue complete. <p/>

  <center><img src="img/move_path.png" height="200" width="200" hspace=10><img src="img/aligned_3_polygons.png" height="150" width="150" hspace="10"><img src="img/remove_outer_polygon.png" height="150" width="150"><img src="img/new_polygon.png" height="200" width="200"></center><p/>

    If a large fused polygon needs to be separated, one can use the eraser tool. Drag the fused polygon away from the tissue, select the eraser tool from the left tool bar, then use the eraser to cut the fused polygon into three independent polygons. Select the cut polygons and click "Break Apart" under the "Path" tab at the top, then the three polygons are entirely separated. Place back the three polygons to make the tissue complete. <p/>

  <center><img src="img/linked_polygon.png" hspace="10"><img src="img/eraser.png" hspace=10 height="200" width="200"><img src="img/erase1.png" height="150" width="150"></center><p/>
  <center><img src="img/erase2.png" hspace="10" height="250" width="250"><img src="img/erase3.png" height="250" width="250"></center><p/>

  9. Fill and stroke <p/><p/>
  Under "Object" tab at the top, select "Fill and Stroke...", then the "Fill and Stroke (Shift+Ctrl+F)" panel will come out on the right. Select all polygons by drawing a large rectangle over them. <p/>
  <center><img src="img/fill_tab.png" height="200" width="200" hspace=10><img src="img/select_all1.png" height="200" width="200"></center><p/>

    Under the "Stroke paint" tab in the fill and stroke panel, select "Flat color". <b> Must make sure the “Alpha (opacity)” is 255, “Opacity(%)” is 100.0, and “Blur(%)” is 0.0 </b>. Under the "Stroke style" tab, set the stroke width, e.g.: 1.5 px. <p/>
  <center><img src="img/stroke_flat_color.png" height="250" width="250" hspace=10><img src="img/stroke_opacity.png" height="250" width="250" hspace=10><img src="img/stroke_width.png" height="200" width="200"></center><p/>

    Under the "Fill" tab, click "No paint", then the resulting blank svg image is ready to be used in next section. <p/>
  <center><img src="img/fill_no_paint.png" height="250" width="250" hspace=10><img src="img/blank.png" height="200" width="200"></center><p/>

## Link the svg image with gene matrix

  In the svg image, each polygon is defined by a string of coordinates, and these strings have unique IDs. To use the Spatial Heatmap, these IDs should be replaced with sample names <b>exactly from gene matrix</b>. <b> No matter how the blank svg image is created, it should be [placed inside a layer](#layer) before linked to the gene matrix </b>.

  10. Group same tissues <p/><p/>
  If multiple polygons belong to the same tissue type, they can be grouped together. The example of grouping epidermis is given below. Open "XML Editor..." under the "Edit" tab on the top, then the "XML Editor (Shift+Ctrl+X)" panel comes out on the right. Select all the epidermis polygons by pressing the "Shift" key, right click and select "Group".  
  <p/><center><img src="img/select_group.png" height="250" width="250" hspace="30"><img src="img/group.png" height="250" width="250"></center><p/>

  11. Associate polygons with samples <p/><p/>
  The corresponding epidermis group \<svg:g id="987"\> shows up in the XML panel. Click "id", change "g939" to "epidermis", and click "Set", then the new group id is set. This means all the polygons in this group correspond to epidermis.
  <p/><center><img src="img/click_id.png" height="250" width="250" hspace="20"><img src="img/set_id.png" height="250" width="250"></center><p/> 

    In the "Fill and Stroke (Shift+Ctrl+F)" panel, select "Flat color" under the "Fill" tag, then specify a color for epidermis (e.g. green). <b> Must make sure the “Alpha (opacity)” is 255, “Opacity(%)” is 100.0, and “Blur(%)” is 0.0 </b>. <p/>
  <center><img src="img/flat_color.png" height="250" width="250" hspace=10><img src="img/epi_opacity.png" height="250" width="250" hspace="10"><img src="img/fill_epidermis.png" height="200" width="200"></center><p/>

    Group other tissues, set ids and colours. <p/>
  <center><img src="img/colored.png" height="250" width="250"></center><p/>

  12. Tiny polygons <p/><p/>
  If the resolution of the template png image is poor, GIMP can produce tiny polygons. These tiny polygons can interfere with colour mapping in the spatial heatmap, i.e. some polygons in one tissue are mapped with the colour from the neighbour tissue. If this error arises, it suggests the presense of "tiny" polygons. <b> One sulution is to delete these tiny polygons from related tissue groups in the Inkscape XML editor. These tiny polygons only interfere with the group below them, so if such tiny polygons exist only in one tissue group (e.g. the stele tissue group in the root center), another solution is to place the group containing tiny polygons at the bottom in the XML editor, then no group will be interfered with. </b> 

<center><img src="img/path_bottom.png" height="500" width="500"></center><p/>

  13. Encircling polygons <p/><p/>
  <b> If a polygon encircles other polygons and does not have a corresponding sample in the gene matrix, just a structure of the whole tissue, its "path" should be placed to the top over other "paths" in the "XML Editor". Otherwise, it can hide other tissues. </b> E.g. In the brain svg image, the grey outer polygon (the path "rect5480") encircling all other polygons is at the top over other "paths", which is drawn with Inkscape by refering to [here](http://anatomybodysystem.com/lateral-view-of-the-brain-labeled/lateral-view-of-the-brain-labeled-brain-diagram-and-label-anatomy-body-list/) and [here](https://www.epilepsyresearch.org.uk/the-hippocampus-what-is-it/). <p/>
  <center><img src="img/brain.png" height="500" width="500"></center><p/>

## Add text to label tissues

  Users can add text to label tissues. Basically, the text is first typed in with the text tool and then the text object is coverted to paths. Next text paths are added into the polygon group of target tissue and filled with the same tissue colour.

  14. Creat text paths <p/><p/>
  Select "Creat and select text objects (F8)" from the left tool bar, drag a text box, and type (epidermis). Click on the text object and convert it to path. 
  <center><img src="img/creat_text.png" height="150" width="150" hspace=10><img src="img/text_box.png" height="100" width="100" hspace=10><img src="img/type.png" height="150" width="150" hspace=10><img src="img/object_to_path1.png" height="150" width="150"></center><p/>

  15. Text fill and stroke <p/><p/>
  Click on the text paths and fill them with the same colour of target tissue using "Pick colors from image (F7)" from the left tool bar. In the "Fill and Stroke" panel, set the stroke style and make sure <b> the “Alpha (opacity)” is 255, “Opacity(%)” is 100.0, and “Blur(%)” is 0.0 for both fill and stroke </b>.  
  <center><img src="img/pick_color_tool.png" height="200" width="200" hspace=10><img src="img/epidermis_green.png" height="200" width="200" hspace=20><img src="img/stroke_style.png" height="200" width="200"></center><p/>

  16. Add text paths to tissue group <p/><p/>
  Click and cut the text. Double click the target tissue (epidermis, green) to enter the group.  
  <center><img src="img/click_group.png" height="380" width="380" hspace=3><img src="img/enter_group.png" height="380" width="380"></center><p/>

  Paste the text anywhere and move/resize it, then right click the text and ungroup it.  
  <center><img src="img/paste_text.png" height="450" width="450" hspace=5><img src="img/ungroup_text.png" height="310" width="310" hspace=5></center><p/>

  All the text paths are in the target tissue group (epidermis).  
  <center><img src="img/ungroup_text1.png" height="380" width="380"></center><p/>

  To add a pointer, [draw a rectangle](#shape) and convert it to path, fill it with the same style as the target tissue, then move, rotate and resize it.  

  <center><img src="img/drag_pointer.png" height="150" width="150"></center><p/>

  Click one of any other tissues, then drag the target tissue to see the text and pointer are grouped together with the target.  

  <center><img src="img/click_other_group.png" height="250" width="250" hspace=5><img src="img/drag_new_group.png" height="250" width="250"></center><p/>

  Similarly, add text to other tissues.  
  <center><img src="img/all_text_added.png" height="250" width="250"></center><p/> 

  17. Save the final svg graph, which is ready to use in the spatialHeatmap. The name of saved svg image can only consists of letters, digits, underscores. E.g. "root_cross_final.svg" is acceptable while "root_cross_final(copy).svg" will give errors. <p/>

## Troubleshooting

  The process of making svg file is error-prone, if errors arise in the Spatial Heatmap app, such as some tissues are missing, then users are advised to double check the bold text above.








# Reference

  1. https://www.gimp.org/tutorials/
  2. https://inkscape.org/en/doc/tutorials/advanced/tutorial-advanced.en.html
  3. http://www.microugly.com/inkscape-quickguide/


